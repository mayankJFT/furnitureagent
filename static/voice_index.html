<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProVia Doors - AI Voice Assistant</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Markdown Parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        :root {
            --primary: #8b5cf6;
            --primary-glow: rgba(139, 92, 246, 0.4);
            --secondary: #06b6d4;
            --accent: #ec4899;
            --bg: #0a0a0f;
            --bg-card: rgba(17, 17, 23, 0.9);
            --bg-elevated: rgba(30, 30, 40, 0.8);
            --text: #f4f4f5;
            --text-secondary: #a1a1aa;
            --text-muted: #71717a;
            --border: rgba(63, 63, 70, 0.4);
            --success: #22c55e;
            --error: #ef4444;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', system-ui, sans-serif;
            background: var(--bg);
            min-height: 100vh;
            color: var(--text);
            overflow: hidden;
            line-height: 1.6;
        }

        /* Background */
        .bg-effects {
            position: fixed;
            inset: 0;
            background:
                radial-gradient(ellipse at 0% 0%, rgba(139, 92, 246, 0.12) 0%, transparent 50%),
                radial-gradient(ellipse at 100% 100%, rgba(6, 182, 212, 0.08) 0%, transparent 50%);
            pointer-events: none;
        }

        /* Layout */
        .app {
            display: grid;
            grid-template-columns: 1fr 380px;
            height: 100vh;
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Chat Section */
        .chat-section {
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--border);
        }

        /* Header */
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 24px;
            border-bottom: 1px solid var(--border);
            background: var(--bg-card);
            backdrop-filter: blur(10px);
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .brand-logo {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .brand h1 {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .brand span {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 14px;
            background: var(--bg-elevated);
            border-radius: 20px;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--text-muted);
        }

        .status-dot.connected { background: var(--success); box-shadow: 0 0 8px var(--success); }
        .status-dot.listening { background: var(--error); box-shadow: 0 0 8px var(--error); animation: pulse 1s infinite; }
        .status-dot.processing { background: var(--primary); box-shadow: 0 0 8px var(--primary); animation: pulse 0.5s infinite; }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.2); }
        }

        /* Messages */
        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .messages::-webkit-scrollbar { width: 6px; }
        .messages::-webkit-scrollbar-track { background: transparent; }
        .messages::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

        /* Message */
        .message {
            display: flex;
            gap: 12px;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            flex-shrink: 0;
            margin-top: 2px;
        }

        .message.assistant .message-avatar {
            background: linear-gradient(135deg, var(--primary), var(--accent));
        }

        .message.user .message-avatar {
            background: linear-gradient(135deg, var(--secondary), #0891b2);
        }

        .message-content {
            max-width: 75%;
            min-width: 100px;
        }

        .message-bubble {
            padding: 14px 18px;
            border-radius: 16px;
            font-size: 0.9rem;
        }

        .message.assistant .message-bubble {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-top-left-radius: 4px;
        }

        .message.user .message-bubble {
            background: linear-gradient(135deg, var(--secondary), #0891b2);
            border-top-right-radius: 4px;
        }

        .message.speaking .message-bubble {
            border-color: var(--primary);
            box-shadow: 0 0 20px var(--primary-glow);
        }

        /* Markdown Styles */
        .message-bubble h1, .message-bubble h2, .message-bubble h3 {
            margin: 16px 0 8px 0;
            font-weight: 600;
            color: var(--text);
        }

        .message-bubble h1:first-child,
        .message-bubble h2:first-child,
        .message-bubble h3:first-child {
            margin-top: 0;
        }

        .message-bubble h1 { font-size: 1.2rem; }
        .message-bubble h2 { font-size: 1.1rem; }
        .message-bubble h3 { font-size: 1rem; }

        .message-bubble p {
            margin: 8px 0;
        }

        .message-bubble p:first-child { margin-top: 0; }
        .message-bubble p:last-child { margin-bottom: 0; }

        .message-bubble strong {
            color: var(--primary);
            font-weight: 600;
        }

        .message.user .message-bubble strong {
            color: #a5f3fc;
        }

        .message-bubble ul, .message-bubble ol {
            margin: 12px 0;
            padding-left: 20px;
        }

        .message-bubble li {
            margin: 6px 0;
            padding-left: 4px;
        }

        .message-bubble li::marker {
            color: var(--primary);
        }

        .message-bubble code {
            background: rgba(139, 92, 246, 0.2);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.85em;
            font-family: 'Monaco', 'Consolas', monospace;
        }

        .message-bubble pre {
            background: rgba(0, 0, 0, 0.3);
            padding: 12px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 12px 0;
        }

        .message-bubble pre code {
            background: none;
            padding: 0;
        }

        .message-bubble a {
            color: var(--secondary);
            text-decoration: none;
        }

        .message-bubble a:hover {
            text-decoration: underline;
        }

        .message-bubble blockquote {
            border-left: 3px solid var(--primary);
            padding-left: 12px;
            margin: 12px 0;
            color: var(--text-secondary);
            font-style: italic;
        }

        /* Image in message */
        .message-image {
            margin-top: 12px;
            border-radius: 12px;
            overflow: hidden;
            max-width: 300px;
        }

        .message-image img {
            width: 100%;
            height: auto;
            display: block;
        }

        /* Word highlighting for streaming */
        .word {
            display: inline;
            transition: color 0.2s, text-shadow 0.2s;
        }

        .word.current {
            color: var(--primary);
            text-shadow: 0 0 10px var(--primary-glow);
        }

        .word.spoken {
            color: var(--text-secondary);
        }

        /* Typing indicator */
        .typing {
            display: none;
            align-items: center;
            gap: 12px;
        }

        .typing.active { display: flex; }

        .typing-avatar {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .typing-dots {
            display: flex;
            gap: 4px;
            padding: 14px 18px;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 16px;
            border-top-left-radius: 4px;
        }

        .typing-dots span {
            width: 8px;
            height: 8px;
            background: var(--primary);
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out;
        }

        .typing-dots span:nth-child(1) { animation-delay: 0s; }
        .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
        .typing-dots span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes bounce {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-6px); }
        }

        /* Voice Panel */
        .voice-panel {
            display: flex;
            flex-direction: column;
            background: var(--bg-card);
            backdrop-filter: blur(10px);
            padding: 24px;
        }

        .voice-header {
            text-align: center;
            margin-bottom: 24px;
        }

        .voice-header h2 {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .voice-header p {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        /* Visualizer */
        .visualizer {
            position: relative;
            height: 160px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 24px;
        }

        .visualizer-rings {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .ring {
            position: absolute;
            border: 2px solid var(--primary);
            border-radius: 50%;
            opacity: 0;
        }

        .ring.active {
            animation: ringExpand 2s infinite ease-out;
        }

        .ring:nth-child(1) { animation-delay: 0s; }
        .ring:nth-child(2) { animation-delay: 0.5s; }
        .ring:nth-child(3) { animation-delay: 1s; }

        @keyframes ringExpand {
            0% { width: 50px; height: 50px; opacity: 0.6; }
            100% { width: 150px; height: 150px; opacity: 0; }
        }

        .wave-bars {
            display: flex;
            align-items: center;
            gap: 3px;
            z-index: 1;
        }

        .bar {
            width: 4px;
            height: 20px;
            background: linear-gradient(to top, var(--primary), var(--accent));
            border-radius: 2px;
            transition: height 0.1s ease;
        }

        .bar.active {
            animation: wave 0.6s ease-in-out infinite;
        }

        @keyframes wave {
            0%, 100% { height: 20px; }
            50% { height: 50px; }
        }

        .bar:nth-child(1), .bar:nth-child(18) { animation-delay: 0.0s; }
        .bar:nth-child(2), .bar:nth-child(17) { animation-delay: 0.05s; }
        .bar:nth-child(3), .bar:nth-child(16) { animation-delay: 0.1s; }
        .bar:nth-child(4), .bar:nth-child(15) { animation-delay: 0.15s; }
        .bar:nth-child(5), .bar:nth-child(14) { animation-delay: 0.2s; }
        .bar:nth-child(6), .bar:nth-child(13) { animation-delay: 0.25s; }
        .bar:nth-child(7), .bar:nth-child(12) { animation-delay: 0.3s; }
        .bar:nth-child(8), .bar:nth-child(11) { animation-delay: 0.35s; }
        .bar:nth-child(9), .bar:nth-child(10) { animation-delay: 0.4s; }

        /* Interim text */
        .interim {
            min-height: 24px;
            text-align: center;
            font-size: 0.85rem;
            color: var(--text-secondary);
            font-style: italic;
            margin-bottom: 20px;
            padding: 0 16px;
        }

        /* Mic button */
        .mic-wrapper {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }

        .mic-btn {
            width: 72px;
            height: 72px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 0 30px var(--primary-glow);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .mic-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 40px var(--primary-glow);
        }

        .mic-btn.listening {
            background: linear-gradient(135deg, var(--error), #f97316);
            box-shadow: 0 0 30px rgba(239, 68, 68, 0.4);
            animation: micPulse 1.5s infinite;
        }

        .mic-btn.speaking {
            background: linear-gradient(135deg, var(--secondary), #0891b2);
            box-shadow: 0 0 30px rgba(6, 182, 212, 0.4);
        }

        @keyframes micPulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.5); }
            50% { box-shadow: 0 0 0 20px rgba(239, 68, 68, 0); }
        }

        .mic-btn svg {
            width: 28px;
            height: 28px;
        }

        /* Controls */
        .controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .ctrl-btn {
            padding: 8px 16px;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-secondary);
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .ctrl-btn:hover {
            background: var(--border);
            color: var(--text);
        }

        /* Auto-listen */
        .auto-listen {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            padding: 12px;
            background: var(--bg-elevated);
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .toggle {
            width: 44px;
            height: 24px;
            background: var(--border);
            border-radius: 12px;
            cursor: pointer;
            position: relative;
            transition: background 0.3s;
        }

        .toggle.on { background: var(--primary); }

        .toggle::after {
            content: '';
            position: absolute;
            width: 18px;
            height: 18px;
            background: white;
            border-radius: 50%;
            top: 3px;
            left: 3px;
            transition: transform 0.3s;
        }

        .toggle.on::after { transform: translateX(20px); }

        .toggle-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        /* Input */
        .input-area {
            margin-top: auto;
        }

        .input-box {
            display: flex;
            gap: 8px;
            padding: 6px;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 12px;
            transition: border-color 0.2s;
        }

        .input-box:focus-within {
            border-color: var(--primary);
        }

        .input-box input {
            flex: 1;
            background: transparent;
            border: none;
            padding: 10px 12px;
            color: var(--text);
            font-size: 0.9rem;
            outline: none;
            font-family: inherit;
        }

        .input-box input::placeholder { color: var(--text-muted); }

        .send-btn {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            border: none;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            color: white;
            cursor: pointer;
            transition: transform 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .send-btn:hover { transform: scale(1.05); }

        /* Quick actions */
        .quick-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
            justify-content: center;
        }

        .quick-btn {
            padding: 6px 12px;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 16px;
            color: var(--text-muted);
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .quick-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        /* Responsive */
        @media (max-width: 900px) {
            .app {
                grid-template-columns: 1fr;
                grid-template-rows: 1fr auto;
            }

            .voice-panel {
                border-top: 1px solid var(--border);
                padding: 16px;
            }

            .chat-section {
                border-right: none;
            }

            .visualizer { height: 100px; }
        }
    </style>
</head>
<body>
    <div class="bg-effects"></div>

    <div class="app">
        <section class="chat-section">
            <header class="header">
                <div class="brand">
                    <div class="brand-logo">ðŸšª</div>
                    <div>
                        <h1>ProVia Doors</h1>
                        <span>AI Assistant</span>
                    </div>
                </div>
                <div class="status">
                    <div class="status-dot" id="statusDot"></div>
                    <span id="statusText">Connecting...</span>
                </div>
            </header>

            <div class="messages" id="messages">
                <div class="typing" id="typing">
                    <div class="typing-avatar">ðŸšª</div>
                    <div class="typing-dots">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </div>
            </div>
        </section>

        <aside class="voice-panel">
            <div class="voice-header">
                <h2>Voice Control</h2>
                <p>Tap to speak or enable auto-listen</p>
            </div>

            <div class="visualizer">
                <div class="visualizer-rings">
                    <div class="ring"></div>
                    <div class="ring"></div>
                    <div class="ring"></div>
                </div>
                <div class="wave-bars" id="waveBars"></div>
            </div>

            <div class="interim" id="interim"></div>

            <div class="mic-wrapper">
                <button class="mic-btn" id="micBtn">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/>
                        <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
                        <line x1="12" y1="19" x2="12" y2="23"/>
                        <line x1="8" y1="23" x2="16" y2="23"/>
                    </svg>
                </button>
            </div>

            <div class="controls">
                <button class="ctrl-btn" id="stopBtn">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                        <rect x="6" y="6" width="12" height="12" rx="2"/>
                    </svg>
                    Stop
                </button>
            </div>

            <div class="auto-listen">
                <span class="toggle-label">Auto-Listen</span>
                <div class="toggle" id="autoToggle"></div>
            </div>

            <div class="input-area">
                <div class="input-box">
                    <input type="text" id="textInput" placeholder="Type a message..." autocomplete="off">
                    <button class="send-btn" id="sendBtn">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="22" y1="2" x2="11" y2="13"/>
                            <polygon points="22 2 15 22 11 13 2 9 22 2"/>
                        </svg>
                    </button>
                </div>
                <div class="quick-actions">
                    <button class="quick-btn" data-msg="Tell me about entry doors">Entry Doors</button>
                    <button class="quick-btn" data-msg="What storm doors do you have?">Storm Doors</button>
                    <button class="quick-btn" data-msg="Glass options">Glass</button>
                    <button class="quick-btn" data-msg="Hardware">Hardware</button>
                </div>
            </div>
        </aside>
    </div>

    <script>
        // Configure marked for markdown
        marked.setOptions({
            breaks: true,
            gfm: true
        });

        // Elements
        const messagesEl = document.getElementById('messages');
        const typingEl = document.getElementById('typing');
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        const micBtn = document.getElementById('micBtn');
        const stopBtn = document.getElementById('stopBtn');
        const autoToggle = document.getElementById('autoToggle');
        const textInput = document.getElementById('textInput');
        const sendBtn = document.getElementById('sendBtn');
        const quickBtns = document.querySelectorAll('.quick-btn');
        const interimEl = document.getElementById('interim');
        const waveBarsEl = document.getElementById('waveBars');
        const rings = document.querySelectorAll('.ring');

        // Create wave bars
        for (let i = 0; i < 18; i++) {
            const bar = document.createElement('div');
            bar.className = 'bar';
            waveBarsEl.appendChild(bar);
        }
        const bars = document.querySelectorAll('.bar');

        // State
        let ws = null;
        let connected = false;
        let recognition = null;
        let listening = false;
        let speaking = false;
        let autoListen = false;
        let audioCtx = null;
        let analyser = null;

        // Streaming state
        let streamingEl = null;
        let streamingText = null;
        let audioQueue = [];
        let wordQueue = [];
        let playingAudio = false;
        let currentAudio = null;
        let wordInterval = null;

        // Parse markdown to HTML
        function parseMarkdown(text) {
            // Use marked library for full markdown support
            return marked.parse(text);
        }

        // Add message to chat
        function addMessage(content, sender, isStreaming = false) {
            const msgDiv = document.createElement('div');
            msgDiv.className = `message ${sender}`;

            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.textContent = sender === 'user' ? 'ðŸ‘¤' : 'ðŸšª';

            const contentWrapper = document.createElement('div');
            contentWrapper.className = 'message-content';

            const bubble = document.createElement('div');
            bubble.className = 'message-bubble';

            if (isStreaming) {
                // For streaming, we'll add words one by one
                const textEl = document.createElement('div');
                textEl.className = 'streaming-text';
                bubble.appendChild(textEl);
            } else {
                // Parse markdown for non-streaming messages
                bubble.innerHTML = parseMarkdown(content);
            }

            contentWrapper.appendChild(bubble);
            msgDiv.appendChild(avatar);
            msgDiv.appendChild(contentWrapper);

            messagesEl.insertBefore(msgDiv, typingEl);
            messagesEl.scrollTop = messagesEl.scrollHeight;

            return msgDiv;
        }

        // Create streaming message
        function createStreamingMessage() {
            const msgDiv = document.createElement('div');
            msgDiv.className = 'message assistant speaking';

            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.textContent = 'ðŸšª';

            const contentWrapper = document.createElement('div');
            contentWrapper.className = 'message-content';

            const bubble = document.createElement('div');
            bubble.className = 'message-bubble';

            const textEl = document.createElement('div');
            textEl.className = 'streaming-text';
            bubble.appendChild(textEl);

            contentWrapper.appendChild(bubble);
            msgDiv.appendChild(avatar);
            msgDiv.appendChild(contentWrapper);

            messagesEl.insertBefore(msgDiv, typingEl);
            return msgDiv;
        }

        // Show word with highlight
        function showWord(word) {
            if (!streamingText) return;

            // Remove current highlight from previous word
            const prev = streamingText.querySelector('.word.current');
            if (prev) {
                prev.classList.remove('current');
                prev.classList.add('spoken');
            }

            // Add new word
            const span = document.createElement('span');
            span.className = 'word current';
            span.textContent = word;
            streamingText.appendChild(span);

            messagesEl.scrollTop = messagesEl.scrollHeight;
        }

        // Finalize streaming message with markdown
        function finalizeStreamingMessage(fullText) {
            if (streamingEl) {
                const bubble = streamingEl.querySelector('.message-bubble');
                if (bubble) {
                    bubble.innerHTML = parseMarkdown(fullText);
                }
                streamingEl.classList.remove('speaking');
            }
        }

        // Audio playback
        function stopAllAudio() {
            audioQueue = [];
            wordQueue = [];
            if (wordInterval) {
                clearInterval(wordInterval);
                wordInterval = null;
            }
            if (currentAudio) {
                currentAudio.pause();
                currentAudio = null;
            }
            playingAudio = false;
        }

        function playNextAudio() {
            if (playingAudio || audioQueue.length === 0) return;

            playingAudio = true;
            const data = audioQueue.shift();
            const words = data.words || [];

            const audio = new Audio(`data:audio/${data.format};base64,${data.audio}`);
            currentAudio = audio;

            audio.onplay = () => {
                if (words.length > 0 && streamingText) {
                    const duration = audio.duration * 1000;
                    const perWord = duration / words.length;
                    let idx = 0;

                    showWord(words[idx++].word);

                    if (words.length > 1) {
                        wordInterval = setInterval(() => {
                            if (idx < words.length && streamingText) {
                                showWord(words[idx++].word);
                            }
                            if (idx >= words.length) {
                                clearInterval(wordInterval);
                                wordInterval = null;
                            }
                        }, perWord);
                    }
                }
            };

            audio.onended = () => {
                playingAudio = false;
                currentAudio = null;
                if (wordInterval) {
                    clearInterval(wordInterval);
                    wordInterval = null;
                }
                playNextAudio();
            };

            audio.onerror = () => {
                // Show words even if audio fails
                if (words.length > 0 && streamingText) {
                    words.forEach(w => showWord(w.word));
                }
                playingAudio = false;
                currentAudio = null;
                playNextAudio();
            };

            audio.play().catch(() => {
                if (words.length > 0 && streamingText) {
                    words.forEach(w => showWord(w.word));
                }
                playingAudio = false;
                currentAudio = null;
                playNextAudio();
            });
        }

        function checkAudioComplete(fullText) {
            if (audioQueue.length === 0 && !playingAudio) {
                // Finalize with markdown formatting
                finalizeStreamingMessage(fullText);
                streamingEl = null;
                streamingText = null;
                finishSpeaking();
            } else {
                setTimeout(() => checkAudioComplete(fullText), 100);
            }
        }

        // Speech recognition
        function initRecognition() {
            if (!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) {
                micBtn.disabled = true;
                return false;
            }

            const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SR();
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = 'en-US';

            recognition.onstart = () => {
                listening = true;
                micBtn.classList.add('listening');
                statusDot.className = 'status-dot listening';
                statusText.textContent = 'Listening...';
                rings.forEach(r => r.classList.add('active'));
                bars.forEach(b => b.classList.add('active'));
            };

            recognition.onresult = (e) => {
                let interim = '', final = '';
                for (let i = e.resultIndex; i < e.results.length; i++) {
                    const t = e.results[i][0].transcript;
                    if (e.results[i].isFinal) final += t;
                    else interim += t;
                }
                interimEl.textContent = interim;
                if (final.trim()) {
                    interimEl.textContent = '';
                    sendMessage(final.trim());
                }
            };

            recognition.onerror = (e) => {
                if (e.error !== 'no-speech' && e.error !== 'aborted') {
                    console.error('Speech error:', e.error);
                }
            };

            recognition.onend = () => {
                listening = false;
                micBtn.classList.remove('listening');
                rings.forEach(r => r.classList.remove('active'));
                bars.forEach(b => b.classList.remove('active'));
                bars.forEach(b => b.style.height = '20px');

                if (autoListen && !speaking) {
                    setTimeout(() => {
                        if (autoListen && !speaking && !listening) startListening();
                    }, 500);
                } else {
                    statusDot.className = 'status-dot connected';
                    statusText.textContent = 'Ready';
                }
            };

            return true;
        }

        function startListening() {
            if (speaking) stopSpeaking();
            if (recognition && !listening) {
                try { recognition.start(); } catch(e) {}
            }
        }

        function stopListening() {
            listening = false;
            micBtn.classList.remove('listening');
            rings.forEach(r => r.classList.remove('active'));
            bars.forEach(b => b.classList.remove('active'));
            if (recognition) try { recognition.stop(); } catch(e) {}
            bars.forEach(b => b.style.height = '20px');
            statusDot.className = 'status-dot connected';
            statusText.textContent = 'Ready';
        }

        function finishSpeaking() {
            speaking = false;
            micBtn.classList.remove('speaking');
            bars.forEach(b => b.classList.remove('active'));
            statusDot.className = 'status-dot connected';
            statusText.textContent = 'Ready';

            if (autoListen) {
                setTimeout(() => {
                    if (autoListen && !speaking) startListening();
                }, 800);
            }
        }

        function stopSpeaking() {
            stopAllAudio();
            speaking = false;
            micBtn.classList.remove('speaking');
            bars.forEach(b => b.classList.remove('active'));
            if (streamingEl) streamingEl.classList.remove('speaking');
            streamingEl = null;
            streamingText = null;
            stopListening();
            if (autoListen) toggleAutoListen();
        }

        function toggleAutoListen() {
            autoListen = !autoListen;
            autoToggle.classList.toggle('on', autoListen);
            if (autoListen && !listening && !speaking) startListening();
            else if (!autoListen) stopListening();
        }

        // WebSocket
        let fullTextBuffer = '';

        function connect() {
            const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${proto}//${location.host}/ws/voice`);

            ws.onopen = () => {
                connected = true;
                statusDot.className = 'status-dot connected';
                statusText.textContent = 'Connected';
            };

            ws.onmessage = (e) => {
                const d = JSON.parse(e.data);

                if (d.type === 'processing') {
                    typingEl.classList.toggle('active', d.content);
                    if (d.content) {
                        statusDot.className = 'status-dot processing';
                        statusText.textContent = 'Thinking...';
                    }
                    messagesEl.scrollTop = messagesEl.scrollHeight;
                }
                else if (d.type === 'stream_start') {
                    streamingEl = createStreamingMessage();
                    streamingText = streamingEl.querySelector('.streaming-text');
                    audioQueue = [];
                    wordQueue = [];
                    fullTextBuffer = '';
                    speaking = true;
                    micBtn.classList.add('speaking');
                    statusDot.className = 'status-dot processing';
                    statusText.textContent = 'Speaking...';
                    bars.forEach(b => b.classList.add('active'));
                }
                else if (d.type === 'stream_word') {
                    wordQueue.push({ word: d.word, delay: d.delay || 300 });
                    fullTextBuffer += d.word;
                }
                else if (d.type === 'stream_audio') {
                    const wordsForAudio = wordQueue.splice(0, d.wordCount);
                    audioQueue.push({ audio: d.audio, format: d.format, words: wordsForAudio });
                    if (!playingAudio) playNextAudio();
                }
                else if (d.type === 'stream_end') {
                    const fullText = d.fullText || fullTextBuffer;
                    checkAudioComplete(fullText);
                }
                else if (d.type === 'assistant') {
                    addMessage(d.content, 'assistant');
                }
                else if (d.type === 'error') {
                    addMessage(d.content, 'assistant');
                }
            };

            ws.onclose = () => {
                connected = false;
                statusDot.className = 'status-dot';
                statusText.textContent = 'Reconnecting...';
                setTimeout(connect, 3000);
            };
        }

        function sendMessage(msg) {
            if (!msg.trim() || !connected) return;
            addMessage(msg, 'user');
            ws.send(JSON.stringify({ type: 'text', content: msg }));
            textInput.value = '';
            interimEl.textContent = '';
        }

        // Event listeners
        micBtn.onclick = () => {
            if (listening) {
                stopListening();
                if (autoListen) toggleAutoListen();
            } else {
                startListening();
            }
        };

        stopBtn.onclick = stopSpeaking;
        autoToggle.onclick = toggleAutoListen;
        sendBtn.onclick = () => sendMessage(textInput.value);
        textInput.onkeypress = (e) => { if (e.key === 'Enter') sendMessage(textInput.value); };
        quickBtns.forEach(btn => btn.onclick = () => sendMessage(btn.dataset.msg));

        // Initialize
        initRecognition();
        connect();
    </script>
</body>
</html>
