<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProVia Doors - AI Voice Assistant</title>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #a855f7;
            --primary-glow: rgba(168, 85, 247, 0.5);
            --secondary: #06b6d4;
            --secondary-glow: rgba(6, 182, 212, 0.5);
            --accent: #f472b6;
            --bg-dark: #09090b;
            --bg-card: rgba(24, 24, 27, 0.8);
            --bg-elevated: rgba(39, 39, 42, 0.6);
            --text-primary: #fafafa;
            --text-secondary: #a1a1aa;
            --text-muted: #71717a;
            --border: rgba(63, 63, 70, 0.5);
            --success: #34d399;
            --error: #f87171;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Space Grotesk', -apple-system, sans-serif;
            background: var(--bg-dark);
            min-height: 100vh;
            color: var(--text-primary);
            overflow: hidden;
        }

        /* Mesh gradient background */
        .mesh-bg {
            position: fixed;
            inset: 0;
            background:
                radial-gradient(at 0% 0%, rgba(168, 85, 247, 0.15) 0px, transparent 50%),
                radial-gradient(at 100% 0%, rgba(6, 182, 212, 0.12) 0px, transparent 50%),
                radial-gradient(at 100% 100%, rgba(244, 114, 182, 0.1) 0px, transparent 50%),
                radial-gradient(at 0% 100%, rgba(168, 85, 247, 0.08) 0px, transparent 50%);
            z-index: -2;
        }

        /* Animated grid */
        .grid-bg {
            position: fixed;
            inset: 0;
            background-image:
                linear-gradient(rgba(168, 85, 247, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(168, 85, 247, 0.03) 1px, transparent 1px);
            background-size: 50px 50px;
            z-index: -1;
            animation: gridMove 20s linear infinite;
        }

        @keyframes gridMove {
            0% { transform: translate(0, 0); }
            100% { transform: translate(50px, 50px); }
        }

        /* Floating particles */
        .particle {
            position: fixed;
            width: 4px;
            height: 4px;
            background: var(--primary);
            border-radius: 50%;
            pointer-events: none;
            opacity: 0.6;
            animation: particleFloat 15s infinite ease-in-out;
        }

        .particle:nth-child(1) { left: 10%; top: 20%; animation-delay: 0s; }
        .particle:nth-child(2) { left: 20%; top: 80%; animation-delay: -3s; background: var(--secondary); }
        .particle:nth-child(3) { left: 60%; top: 40%; animation-delay: -6s; }
        .particle:nth-child(4) { left: 80%; top: 60%; animation-delay: -9s; background: var(--accent); }
        .particle:nth-child(5) { left: 90%; top: 10%; animation-delay: -12s; background: var(--secondary); }

        @keyframes particleFloat {
            0%, 100% { transform: translateY(0) scale(1); opacity: 0.6; }
            50% { transform: translateY(-30px) scale(1.5); opacity: 1; }
        }

        /* App layout */
        .app {
            display: grid;
            grid-template-rows: auto 1fr;
            height: 100vh;
            max-width: 1400px;
            margin: 0 auto;
            padding: 16px;
            gap: 16px;
        }

        /* Header */
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 24px;
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border);
            border-radius: 16px;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 14px;
        }

        .brand-icon {
            width: 44px;
            height: 44px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            box-shadow: 0 0 30px var(--primary-glow);
        }

        .brand-text h1 {
            font-size: 1.2rem;
            font-weight: 600;
            background: linear-gradient(135deg, #fff 0%, var(--primary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .brand-text span {
            font-size: 0.75rem;
            color: var(--text-muted);
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        .status-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: var(--bg-elevated);
            border-radius: 100px;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--text-muted);
            transition: all 0.3s;
        }

        .status-dot.connected { background: var(--success); box-shadow: 0 0 10px var(--success); }
        .status-dot.listening { background: var(--error); box-shadow: 0 0 10px var(--error); animation: pulse 1s infinite; }
        .status-dot.processing { background: var(--primary); box-shadow: 0 0 10px var(--primary); animation: pulse 0.5s infinite; }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.4); }
        }

        /* Main content */
        .main {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 16px;
            overflow: hidden;
        }

        /* Chat area */
        .chat-area {
            display: flex;
            flex-direction: column;
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border);
            border-radius: 20px;
            overflow: hidden;
        }

        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .messages::-webkit-scrollbar { width: 4px; }
        .messages::-webkit-scrollbar-track { background: transparent; }
        .messages::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

        .message {
            display: flex;
            gap: 14px;
            max-width: 85%;
            animation: msgIn 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes msgIn {
            from { opacity: 0; transform: translateY(20px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        .message.user { align-self: flex-end; flex-direction: row-reverse; }

        .msg-avatar {
            width: 38px;
            height: 38px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            flex-shrink: 0;
        }

        .message.user .msg-avatar {
            background: linear-gradient(135deg, var(--secondary) 0%, #0891b2 100%);
        }

        .message.assistant .msg-avatar {
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
        }

        .msg-bubble {
            padding: 14px 18px;
            border-radius: 18px;
            line-height: 1.6;
            font-size: 0.9rem;
        }

        .message.user .msg-bubble {
            background: linear-gradient(135deg, var(--secondary) 0%, #0891b2 100%);
            border-bottom-right-radius: 4px;
        }

        .message.assistant .msg-bubble {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-bottom-left-radius: 4px;
        }

        .message.speaking .msg-bubble {
            border-color: var(--primary);
            box-shadow: 0 0 30px var(--primary-glow);
        }

        /* Word highlighting */
        .word {
            display: inline;
            transition: all 0.2s ease;
        }

        .word.current {
            color: var(--primary);
            text-shadow: 0 0 20px var(--primary-glow);
        }

        .word.spoken {
            color: var(--text-secondary);
        }

        /* Typing indicator */
        .typing {
            display: none;
            gap: 6px;
            padding: 16px 20px;
            background: var(--bg-elevated);
            border-radius: 18px;
            width: fit-content;
        }

        .typing.active { display: flex; }

        .typing span {
            width: 8px;
            height: 8px;
            background: var(--primary);
            border-radius: 50%;
            animation: typingBounce 1.4s infinite ease-in-out;
        }

        .typing span:nth-child(1) { animation-delay: 0s; }
        .typing span:nth-child(2) { animation-delay: 0.2s; }
        .typing span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typingBounce {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-10px); }
        }

        /* Voice panel */
        .voice-panel {
            display: flex;
            flex-direction: column;
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 24px;
        }

        .voice-title {
            text-align: center;
            margin-bottom: 20px;
        }

        .voice-title h2 {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .voice-title p {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        /* Voice visualizer */
        .visualizer {
            position: relative;
            height: 180px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
        }

        .visualizer canvas {
            position: absolute;
            inset: 0;
        }

        /* Circular rings */
        .ring {
            position: absolute;
            border-radius: 50%;
            border: 2px solid var(--primary);
            opacity: 0;
        }

        .ring.active {
            animation: ringPulse 2s infinite ease-out;
        }

        .ring:nth-child(1) { animation-delay: 0s; }
        .ring:nth-child(2) { animation-delay: 0.6s; }
        .ring:nth-child(3) { animation-delay: 1.2s; }

        @keyframes ringPulse {
            0% { width: 60px; height: 60px; opacity: 0.8; border-color: var(--primary); }
            100% { width: 180px; height: 180px; opacity: 0; border-color: var(--secondary); }
        }

        /* Wave bars */
        .wave-bars {
            display: flex;
            align-items: center;
            gap: 4px;
            z-index: 1;
        }

        .bar {
            width: 4px;
            height: 24px;
            background: linear-gradient(180deg, var(--primary) 0%, var(--accent) 100%);
            border-radius: 4px;
            transition: height 0.05s ease;
        }

        .bar.active {
            animation: barWave 0.6s ease-in-out infinite;
        }

        @keyframes barWave {
            0%, 100% { height: 24px; }
            50% { height: 60px; }
        }

        /* Stagger bar animations */
        .bar:nth-child(1), .bar:nth-child(20) { animation-delay: 0.00s; }
        .bar:nth-child(2), .bar:nth-child(19) { animation-delay: 0.05s; }
        .bar:nth-child(3), .bar:nth-child(18) { animation-delay: 0.10s; }
        .bar:nth-child(4), .bar:nth-child(17) { animation-delay: 0.15s; }
        .bar:nth-child(5), .bar:nth-child(16) { animation-delay: 0.20s; }
        .bar:nth-child(6), .bar:nth-child(15) { animation-delay: 0.25s; }
        .bar:nth-child(7), .bar:nth-child(14) { animation-delay: 0.30s; }
        .bar:nth-child(8), .bar:nth-child(13) { animation-delay: 0.35s; }
        .bar:nth-child(9), .bar:nth-child(12) { animation-delay: 0.40s; }
        .bar:nth-child(10), .bar:nth-child(11) { animation-delay: 0.45s; }

        /* Interim text */
        .interim {
            min-height: 28px;
            text-align: center;
            font-size: 0.9rem;
            color: var(--text-secondary);
            font-style: italic;
            margin-bottom: 24px;
            padding: 0 16px;
        }

        /* Mic button */
        .mic-container {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }

        .mic-btn {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            color: white;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            box-shadow: 0 0 40px var(--primary-glow);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .mic-btn::before {
            content: '';
            position: absolute;
            inset: -4px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--secondary), var(--accent));
            z-index: -1;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .mic-btn:hover::before { opacity: 0.5; }

        .mic-btn:hover {
            transform: scale(1.08);
            box-shadow: 0 0 60px var(--primary-glow);
        }

        .mic-btn.listening {
            background: linear-gradient(135deg, #ef4444 0%, #f97316 100%);
            box-shadow: 0 0 40px rgba(239, 68, 68, 0.5);
            animation: micPulse 1.5s infinite;
        }

        .mic-btn.speaking {
            background: linear-gradient(135deg, var(--secondary) 0%, #0891b2 100%);
            box-shadow: 0 0 40px var(--secondary-glow);
        }

        @keyframes micPulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.6); }
            50% { box-shadow: 0 0 0 25px rgba(239, 68, 68, 0); }
        }

        .mic-btn svg {
            width: 32px;
            height: 32px;
        }

        /* Controls */
        .controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .ctrl-btn {
            padding: 10px 18px;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text-secondary);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .ctrl-btn:hover {
            background: var(--border);
            color: var(--text-primary);
        }

        /* Auto-listen toggle */
        .auto-listen {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            padding: 14px;
            background: var(--bg-elevated);
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .toggle {
            width: 48px;
            height: 26px;
            background: var(--border);
            border-radius: 13px;
            cursor: pointer;
            position: relative;
            transition: background 0.3s;
        }

        .toggle.on { background: var(--primary); }

        .toggle::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            top: 3px;
            left: 3px;
            transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .toggle.on::after { transform: translateX(22px); }

        .toggle-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        /* Input area */
        .input-area {
            margin-top: auto;
        }

        .input-box {
            display: flex;
            gap: 10px;
            padding: 8px;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 16px;
            transition: border-color 0.2s;
        }

        .input-box:focus-within {
            border-color: var(--primary);
        }

        .input-box input {
            flex: 1;
            background: transparent;
            border: none;
            padding: 10px 14px;
            color: var(--text-primary);
            font-size: 0.9rem;
            outline: none;
            font-family: inherit;
        }

        .input-box input::placeholder { color: var(--text-muted); }

        .send-btn {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            border: none;
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            color: white;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .send-btn:hover { transform: scale(1.05); }

        /* Quick actions */
        .quick-btns {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 14px;
            justify-content: center;
        }

        .quick-btn {
            padding: 8px 14px;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 100px;
            color: var(--text-muted);
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .quick-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
            background: rgba(168, 85, 247, 0.1);
        }

        /* Responsive */
        @media (max-width: 900px) {
            .main {
                grid-template-columns: 1fr;
                grid-template-rows: auto 1fr;
            }

            .voice-panel {
                order: -1;
                padding: 16px;
            }

            .visualizer { height: 120px; }
            .app { padding: 10px; }
        }
    </style>
</head>
<body>
    <div class="mesh-bg"></div>
    <div class="grid-bg"></div>
    <div class="particle"></div>
    <div class="particle"></div>
    <div class="particle"></div>
    <div class="particle"></div>
    <div class="particle"></div>

    <div class="app">
        <header class="header">
            <div class="brand">
                <div class="brand-icon">ðŸšª</div>
                <div class="brand-text">
                    <h1>ProVia Doors</h1>
                    <span>AI Assistant</span>
                </div>
            </div>
            <div class="status-badge">
                <div class="status-dot" id="statusDot"></div>
                <span id="statusText">Connecting...</span>
            </div>
        </header>

        <main class="main">
            <section class="chat-area">
                <div class="messages" id="messages">
                    <div class="typing" id="typing">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </div>
            </section>

            <aside class="voice-panel">
                <div class="voice-title">
                    <h2>Voice Control</h2>
                    <p>Tap to speak or enable auto-listen</p>
                </div>

                <div class="visualizer" id="visualizer">
                    <canvas id="canvas"></canvas>
                    <div class="ring"></div>
                    <div class="ring"></div>
                    <div class="ring"></div>
                    <div class="wave-bars" id="waveBars"></div>
                </div>

                <div class="interim" id="interim"></div>

                <div class="mic-container">
                    <button class="mic-btn" id="micBtn">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/>
                            <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
                            <line x1="12" y1="19" x2="12" y2="23"/>
                            <line x1="8" y1="23" x2="16" y2="23"/>
                        </svg>
                    </button>
                </div>

                <div class="controls">
                    <button class="ctrl-btn" id="stopBtn">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                            <rect x="6" y="6" width="12" height="12" rx="2"/>
                        </svg>
                        Stop
                    </button>
                </div>

                <div class="auto-listen">
                    <span class="toggle-label">Auto-Listen</span>
                    <div class="toggle" id="autoToggle"></div>
                </div>

                <div class="input-area">
                    <div class="input-box">
                        <input type="text" id="textInput" placeholder="Type a message..." autocomplete="off">
                        <button class="send-btn" id="sendBtn">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="22" y1="2" x2="11" y2="13"/>
                                <polygon points="22 2 15 22 11 13 2 9 22 2"/>
                            </svg>
                        </button>
                    </div>
                    <div class="quick-btns">
                        <button class="quick-btn" data-msg="Tell me about entry doors">Entry Doors</button>
                        <button class="quick-btn" data-msg="What storm doors do you have?">Storm Doors</button>
                        <button class="quick-btn" data-msg="Show me glass options">Glass Options</button>
                        <button class="quick-btn" data-msg="Hardware selection">Hardware</button>
                    </div>
                </div>
            </aside>
        </main>
    </div>

    <script>
        // Elements
        const messages = document.getElementById('messages');
        const typing = document.getElementById('typing');
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        const micBtn = document.getElementById('micBtn');
        const stopBtn = document.getElementById('stopBtn');
        const autoToggle = document.getElementById('autoToggle');
        const textInput = document.getElementById('textInput');
        const sendBtn = document.getElementById('sendBtn');
        const quickBtns = document.querySelectorAll('.quick-btn');
        const interim = document.getElementById('interim');
        const waveBarsContainer = document.getElementById('waveBars');
        const visualizer = document.getElementById('visualizer');
        const canvas = document.getElementById('canvas');
        const rings = document.querySelectorAll('.ring');

        // Create wave bars
        for (let i = 0; i < 20; i++) {
            const bar = document.createElement('div');
            bar.className = 'bar';
            waveBarsContainer.appendChild(bar);
        }
        const bars = document.querySelectorAll('.bar');

        // State
        let ws = null;
        let connected = false;
        let recognition = null;
        let synthesis = window.speechSynthesis;
        let listening = false;
        let speaking = false;
        let autoListen = false;
        let audioCtx = null;
        let analyser = null;
        let animId = null;
        let canvasCtx = null;

        // Streaming state
        let streamingEl = null;
        let streamingText = null;
        let audioQueue = [];
        let wordQueue = [];
        let playingAudio = false;
        let currentAudio = null;
        let wordInterval = null;

        // Init canvas
        function initCanvas() {
            const rect = canvas.parentElement.getBoundingClientRect();
            canvas.width = rect.width;
            canvas.height = rect.height;
            canvasCtx = canvas.getContext('2d');
        }

        // Audio context
        async function initAudio() {
            try {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioCtx.createAnalyser();
                analyser.fftSize = 256;
                analyser.smoothingTimeConstant = 0.8;

                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                const mic = audioCtx.createMediaStreamSource(stream);
                mic.connect(analyser);
                initCanvas();
                return true;
            } catch (e) {
                console.error('Audio init error:', e);
                return false;
            }
        }

        // Visualize
        function visualize() {
            if (!analyser || !listening) {
                bars.forEach(b => b.style.height = '24px');
                if (canvasCtx) canvasCtx.clearRect(0, 0, canvas.width, canvas.height);
                return;
            }

            const data = new Uint8Array(analyser.frequencyBinCount);
            analyser.getByteFrequencyData(data);

            // Update bars
            const step = Math.floor(data.length / bars.length);
            bars.forEach((bar, i) => {
                const val = data[i * step];
                const h = Math.max(24, (val / 255) * 60);
                bar.style.height = `${h}px`;
            });

            // Canvas glow
            if (canvasCtx) {
                const w = canvas.width, h = canvas.height;
                const cx = w / 2, cy = h / 2;
                canvasCtx.clearRect(0, 0, w, h);

                const avg = data.reduce((a, b) => a + b, 0) / data.length;
                const r = 35 + (avg / 255) * 25;

                const grad = canvasCtx.createRadialGradient(cx, cy, 0, cx, cy, r);
                grad.addColorStop(0, `rgba(168, 85, 247, ${0.4 + (avg / 255) * 0.3})`);
                grad.addColorStop(1, 'rgba(168, 85, 247, 0)');

                canvasCtx.beginPath();
                canvasCtx.arc(cx, cy, r, 0, Math.PI * 2);
                canvasCtx.fillStyle = grad;
                canvasCtx.fill();
            }

            animId = requestAnimationFrame(visualize);
        }

        // Speech recognition
        function initRecognition() {
            if (!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) {
                micBtn.disabled = true;
                return false;
            }

            const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SR();
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = 'en-US';

            recognition.onstart = () => {
                listening = true;
                micBtn.classList.add('listening');
                statusDot.className = 'status-dot listening';
                statusText.textContent = 'Listening...';
                rings.forEach(r => r.classList.add('active'));
                bars.forEach(b => b.classList.add('active'));
                visualize();
            };

            recognition.onresult = (e) => {
                let interimResult = '', finalResult = '';
                for (let i = e.resultIndex; i < e.results.length; i++) {
                    const t = e.results[i][0].transcript;
                    if (e.results[i].isFinal) finalResult += t;
                    else interimResult += t;
                }
                interim.textContent = interimResult;
                if (finalResult.trim()) {
                    interim.textContent = '';
                    send(finalResult.trim());
                }
            };

            recognition.onerror = (e) => {
                if (e.error !== 'no-speech' && e.error !== 'aborted') {
                    console.error('Speech error:', e.error);
                }
            };

            recognition.onend = () => {
                listening = false;
                micBtn.classList.remove('listening');
                rings.forEach(r => r.classList.remove('active'));
                bars.forEach(b => b.classList.remove('active'));
                if (animId) { cancelAnimationFrame(animId); animId = null; }
                bars.forEach(b => b.style.height = '24px');
                if (canvasCtx) canvasCtx.clearRect(0, 0, canvas.width, canvas.height);

                if (autoListen && !speaking) {
                    setTimeout(() => {
                        if (autoListen && !speaking && !listening) startListen();
                    }, 500);
                } else {
                    statusDot.className = 'status-dot connected';
                    statusText.textContent = 'Ready';
                }
            };

            return true;
        }

        function startListen() {
            if (speaking) { synthesis.cancel(); speaking = false; }
            if (audioCtx?.state === 'suspended') audioCtx.resume();
            if (recognition && !listening) {
                try { recognition.start(); } catch (e) {}
            }
        }

        function stopListen() {
            listening = false;
            micBtn.classList.remove('listening');
            rings.forEach(r => r.classList.remove('active'));
            bars.forEach(b => b.classList.remove('active'));
            if (recognition) try { recognition.stop(); } catch (e) {}
            if (animId) { cancelAnimationFrame(animId); animId = null; }
            bars.forEach(b => b.style.height = '24px');
            statusDot.className = 'status-dot connected';
            statusText.textContent = 'Ready';
        }

        function finishSpeak() {
            speaking = false;
            micBtn.classList.remove('speaking');
            bars.forEach(b => b.classList.remove('active'));
            statusDot.className = 'status-dot connected';
            statusText.textContent = 'Ready';

            if (autoListen) {
                setTimeout(() => { if (autoListen && !speaking) startListen(); }, 800);
            }
        }

        function stopSpeak() {
            synthesis.cancel();
            stopAllAudio();
            speaking = false;
            micBtn.classList.remove('speaking');
            bars.forEach(b => b.classList.remove('active'));
            if (streamingEl) streamingEl.classList.remove('speaking');
            streamingEl = null;
            streamingText = null;
            stopListen();
            if (autoListen) toggleAuto();
        }

        function toggleAuto() {
            autoListen = !autoListen;
            autoToggle.classList.toggle('on', autoListen);
            if (autoListen && !listening && !speaking) startListen();
            else if (!autoListen) stopListen();
        }

        // Streaming audio
        function stopAllAudio() {
            audioQueue = [];
            wordQueue = [];
            if (wordInterval) { clearInterval(wordInterval); wordInterval = null; }
            if (currentAudio) { currentAudio.pause(); currentAudio = null; }
            playingAudio = false;
        }

        function playNextAudio() {
            if (playingAudio || audioQueue.length === 0) return;
            playingAudio = true;
            const data = audioQueue.shift();
            const words = data.words || [];

            const audio = new Audio(`data:audio/${data.format};base64,${data.audio}`);
            currentAudio = audio;

            audio.onplay = () => {
                if (words.length > 0 && streamingText) {
                    displayWords(words, audio.duration * 1000);
                }
            };

            audio.onended = () => {
                playingAudio = false;
                currentAudio = null;
                if (wordInterval) { clearInterval(wordInterval); wordInterval = null; }
                playNextAudio();
            };

            audio.onerror = () => {
                if (words.length > 0 && streamingText) words.forEach(w => showWord(w.word));
                playingAudio = false;
                currentAudio = null;
                playNextAudio();
            };

            audio.play().catch(() => {
                if (words.length > 0 && streamingText) words.forEach(w => showWord(w.word));
                playingAudio = false;
                currentAudio = null;
                playNextAudio();
            });
        }

        function displayWords(words, duration) {
            if (words.length === 0) return;
            const perWord = duration / words.length;
            let idx = 0;
            showWord(words[idx++].word);
            if (words.length > 1) {
                wordInterval = setInterval(() => {
                    if (idx < words.length && streamingText) {
                        showWord(words[idx++].word);
                    }
                    if (idx >= words.length) { clearInterval(wordInterval); wordInterval = null; }
                }, perWord);
            }
        }

        function showWord(word) {
            if (!streamingText) return;
            const prev = streamingText.querySelector('.word.current');
            if (prev) { prev.classList.remove('current'); prev.classList.add('spoken'); }
            const span = document.createElement('span');
            span.className = 'word current';
            span.textContent = word;
            streamingText.appendChild(span);
            messages.scrollTop = messages.scrollHeight;
        }

        function checkAudioDone() {
            if (audioQueue.length === 0 && !playingAudio) {
                if (streamingText) {
                    const cur = streamingText.querySelector('.word.current');
                    if (cur) { cur.classList.remove('current'); cur.classList.add('spoken'); }
                }
                streamingEl = null;
                streamingText = null;
                finishSpeak();
            } else {
                setTimeout(checkAudioDone, 100);
            }
        }

        // WebSocket
        function connect() {
            const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${proto}//${location.host}/ws/voice`);

            ws.onopen = () => {
                connected = true;
                statusDot.className = 'status-dot connected';
                statusText.textContent = 'Connected';
            };

            ws.onmessage = (e) => {
                const d = JSON.parse(e.data);

                if (d.type === 'processing') {
                    typing.classList.toggle('active', d.content);
                    if (d.content) {
                        statusDot.className = 'status-dot processing';
                        statusText.textContent = 'Thinking...';
                    }
                    messages.scrollTop = messages.scrollHeight;
                }
                else if (d.type === 'stream_start') {
                    streamingEl = createStreamMsg();
                    streamingText = streamingEl.querySelector('.msg-text');
                    audioQueue = [];
                    wordQueue = [];
                    speaking = true;
                    micBtn.classList.add('speaking');
                    statusDot.className = 'status-dot processing';
                    statusText.textContent = 'Speaking...';
                    bars.forEach(b => b.classList.add('active'));
                }
                else if (d.type === 'stream_word') {
                    wordQueue.push({ word: d.word, delay: d.delay || 300 });
                }
                else if (d.type === 'stream_audio') {
                    const wordsForAudio = wordQueue.splice(0, d.wordCount);
                    audioQueue.push({ audio: d.audio, format: d.format, words: wordsForAudio });
                    if (!playingAudio) playNextAudio();
                }
                else if (d.type === 'stream_end') {
                    streamingEl?.classList.remove('speaking');
                    checkAudioDone();
                }
                else if (d.type === 'assistant') {
                    addMsg(d.content, 'assistant');
                }
                else if (d.type === 'error') {
                    addMsg(d.content, 'assistant');
                }
            };

            ws.onclose = () => {
                connected = false;
                statusDot.className = 'status-dot';
                statusText.textContent = 'Reconnecting...';
                setTimeout(connect, 3000);
            };
        }

        function createStreamMsg() {
            const div = document.createElement('div');
            div.className = 'message assistant speaking';
            div.innerHTML = `
                <div class="msg-avatar">ðŸšª</div>
                <div class="msg-bubble"><p class="msg-text"></p></div>
            `;
            messages.insertBefore(div, typing);
            return div;
        }

        function addMsg(text, sender) {
            const div = document.createElement('div');
            div.className = `message ${sender}`;
            div.innerHTML = `
                <div class="msg-avatar">${sender === 'user' ? 'ðŸ‘¤' : 'ðŸšª'}</div>
                <div class="msg-bubble">${text}</div>
            `;
            messages.insertBefore(div, typing);
            messages.scrollTop = messages.scrollHeight;
        }

        function send(msg) {
            if (!msg.trim() || !connected) return;
            addMsg(msg, 'user');
            ws.send(JSON.stringify({ type: 'text', content: msg }));
            textInput.value = '';
            interim.textContent = '';
        }

        // Events
        micBtn.onclick = () => {
            if (listening) { stopListen(); if (autoListen) toggleAuto(); }
            else startListen();
        };

        stopBtn.onclick = stopSpeak;
        autoToggle.onclick = toggleAuto;
        sendBtn.onclick = () => send(textInput.value);
        textInput.onkeypress = (e) => { if (e.key === 'Enter') send(textInput.value); };
        quickBtns.forEach(b => b.onclick = () => send(b.dataset.msg));
        window.onresize = () => { if (canvas) initCanvas(); };

        // Init
        async function init() {
            if (initRecognition()) await initAudio();
            connect();
        }

        init();
    </script>
</body>
</html>
